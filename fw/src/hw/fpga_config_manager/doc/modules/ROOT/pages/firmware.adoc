== Firmware Documentation

There are four distinct tasks that this module can do;

1. Send data to FPGA's FLASH memory
2. Read data from FPGA's FLASH memory (can be used to verify step 1)
3. Trigger FPGA to re-program itself
4. Keep track of the Single Event Upsets (SEU) and correct the errors 

This module uses three important IPs from Xilinx to accomplish the four tasks described above.

* STARTUP (Supported FPGAs: Virtex5, Virtex6, Spartan 6, 7Series, Ultrascale, Ultrascale+)
* ICAP (Same as STARTUP)
* FRAME_ECC (Spartan6 and 7Series)

=== STARTUP

[From Xilinx UG470]
____
The STARTUPE2 primitive provides an interface between the user logic and the configuration logic control and status signals. Many of the pins are related to the startup sequence, including the CLK signal to allow user specification of the startup clock. STARTUPE2 can be instantiated in a design to provide user control over selected configuration signals during device operation.
____

On newer FPGAs, STARTUP primitives will expose FLASH memories SPI interface which usually gets connected to Bank 0. 

CAUTION: On some architectures (eg. 7Series), SPI pins are NOT exposed from STARTUP primitive but the user has to put that into the top port connection. 

=== ICAP 

This primitive enables a programmable logic to modify the FPGA circuit structure and functionality during the operation of the circuit. 

==== IPROG Reconfiguration

[From Xilinx UG570]
____
The internal PROGRAM_B (INTERNAL_PROG or IPROG) command has a similar effect as pulsing the PROGRAM_B pin, except IPROG does not reset the dedicated reconfiguration logic. The start address set in WBSTAR (see Warm Boot Start Address Register (10000) in Chapter 9) is used during SPI or BPI reconfiguration instead of the default address. The default is zero. The IPROG command can be sent through ICAP or the bitstream
____

Imagine below shows the commands for Spartan6 FPGA family IPROG commands.

image::iprog_commands.png[align=center]


=== FRAME_ECC

 Frame ECC logic detects single or double-bit errors in configuration frame data. It uses a 13-bit Hamming code parity value that is calculated based on the frame data generated by BitGen. 

CAUTION: This functionality is only supported for 7SERIES FPGAs in FCM.


=== Overview of the FCM

The image below shows the simplified view of the internals on FCM. 

image::fcm_bd.png[align=center]

=== Programing Procedure Sequence

This module works together with the `mtca4u_fw_programmer`. For more information https://github.com/ChimeraTK/FirmwareProgrammer:"please visit ChimeraTK GitHub Page"

image::fcm_sequence.png[align=center]

* Step 1: The procedure starts by sending the file (.bit/.msc/.bin etc) to the Dual Port Memory(DPM) inside the FCM. 
* Step 2: After sending the file, the finite state machine (FSM) inside the `fpga_spi_programmer` starts sending the data to the FLASH using the STARTUP primitive interface. 

WARNING: Not all FPGA families expose SPI pins of the FLASH through STARTUP. On older FPGAs, SPI pins have to be defined explicitly on the TOP VHDL entity. 

* Step 3: this is usually the verification stage where the data is read back from the FLASH memory.
* Step 4: is the step where ICAP gets signaled with a magic command to trigger FPGA re-programming.



=== SEU Error Correction

This module is currently not integrated into this repository. It can be accessed from https://mskllrfredminesrv.desy.de/svn/utca_firmware_framework/branch/SEU_ERROR/modules/BSP/CONFIG_MANAGER/hdl:"old SVN repo of MSK Group"

